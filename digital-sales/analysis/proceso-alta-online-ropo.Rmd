---
title: "Proceso de alta online. Análisis altas ROPO"
---


```{r, echo = FALSE}
# This is the first mandatory section.

title     <- '[Digital Sales]: Proceso de alta online. Análisis altas ROPO'

keywords  <- 'contratacion cuenta corriente, bbva.es, nuevo cliente, alta cliente, adquisición cliente, oficina, ROPO'  
```

```{r, echo=FALSE}
# This is the second mandatory section.

suppressMessages(library(DBI))    # This avoids loading messages and warnings showing up
suppressMessages(library(rJava))
suppressMessages(library(ggplot2))
suppressMessages(library(grid))
suppressMessages(library(hexbin))
suppressMessages(library(lattice))

options(warn=-1, scipen=3, width=120)
source('~/bda_clarity/tools/warehouse_basics.R') ;
source('~/bda_clarity/tools/write.hive.R') ;

chname <- function(df)
{
  rex <- '^[[:alnum:]_]+\\.([[:alnum:]_]+)$'
  nam <- colnames(df)
  ix  <- which(grepl(rex, nam))
  
  nam[ix] <- gsub(rex, '\\1', nam[ix])
  
  colnames(df) <- nam
  
  df
};

```


Se va a trabajar en las altas de clientes ROPO, realizando el estudio de altas de clientes en oficina tradicional e intentando comprobar si esos clientes anteriormente trataron de realizar el proceso de alta online, fijándonos en las cookies asociadas una vez que han hecho login en la web bbva.es y tienen asociado un código de persona único.

Las tabla que utilizaremos básicamente es TxC (*da_pro.transacciones_por_canal*) y emplearemos además el dato de búsquedas web que nos proporciona la herramienta Omniture.

Empezamos viendo cuántos clientes se han dado de alta en oficina mes a mes desde enero de 2014 (identificados en TxC con *cod_serv_trn=1* y *cod_deve_trn=758*):

```{r cache=TRUE, echo=FALSE}

do.hive("create table IF NOT EXISTS da_martalamela.clientes_oficina as
select cod_anno_ej, cod_mes_ej,
count(*) as n_altas_oficina,
count(distinct case when cod_pers_trs not like '@%' then cod_pers_trs else null end) as n_altas_oficina_identificados
from da_pro.transacciones_por_canal
where cast(cod_serv_dv as int)=1
and cast(cod_deve_trn as int)=758
and cast(partition_id as int) > 20131231
group by cod_anno_ej,cod_mes_ej
order by cod_anno_ej,cod_mes_ej")

clientes_oficina <- qhive("select * from da_martalamela.clientes_oficina")
clientes_oficina$yyyymm <- paste0("20",clientes_oficina$cod_anno_ej,clientes_oficina$cod_mes_ej)

library(ggplot2)

oficina <- data.frame(yyyymm=clientes_oficina$yyyymm,
                altas_oficina=c(clientes_oficina$n_altas_oficina,clientes_oficina$n_altas_oficina_identificados),
                tipo_cliente=c(rep("Total",length(clientes_oficina$yyyymm)),rep("Clientes identificados",length(clientes_oficina$yyyymm))))

#graph_oficina <- ggplot(data=oficina, aes(x=yyyymm, y=altas_oficina, fill=tipo_cliente)) + geom_bar(stat="identity", position=position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de altas") + ggtitle("Altas de clientes en oficina física") + scale_y_continuous(breaks=seq(0,100000,10000)) + guides(fill=guide_legend(title=NULL))

graph_oficina <- ggplot(data=oficina, aes(x=yyyymm, y=altas_oficina, group=tipo_cliente, colour=tipo_cliente)) + geom_line() + geom_point() + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de altas") + ggtitle("Altas de clientes en oficina física") + scale_y_continuous(breaks=seq(0,100000,10000)) + theme(legend.title=element_blank())

graph_oficina

```


**PREGUNTA**: ¿Se identificaban antes las altas en oficina de otro modo? Ya que observamos un cambio claro a partir del segundo trimestre del año 2014.



Y hacemos lo mismo para las altas online (identificadas en TxC con *cod_trnfims='KGCRTQ41'* y *cod_retortr=0*):

```{r cache=TRUE, echo=FALSE}

do.hive("create table IF NOT EXISTS da_martalamela.clientes_online as
select cod_anno_ej, cod_mes_ej,
count(*) as n_altas_online,
count(distinct case when cod_pers_trs not like '@%' then cod_pers_trs else null end) as n_altas_online_identificados
from da_pro.transacciones_por_canal
where cod_trnfims='KGCRTQ41'
and cast(cod_retortr as int)=0
and cast(partition_id as int) > 20131231
group by cod_anno_ej,cod_mes_ej
order by cod_anno_ej,cod_mes_ej")

clientes_online <- qhive("select * from da_martalamela.clientes_online")
clientes_online$yyyymm <- paste0("20",clientes_online$cod_anno_ej,clientes_online$cod_mes_ej)

online <- data.frame(yyyymm=clientes_online$yyyymm,
                altas_online=c(clientes_online$n_altas_online,clientes_online$n_altas_online_identificados),
                tipo_cliente=c(rep("Total",length(clientes_online$yyyymm)),rep("Clientes identificados",length(clientes_online$yyyymm))))

#graph_online <- ggplot(data=online, aes(x=yyyymm, y=altas_online, fill=tipo_cliente)) + geom_bar(stat="identity", position=position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de altas") + ggtitle("Altas de clientes online") + scale_y_continuous(breaks=seq(0,100000,10000)) + guides(fill=guide_legend(title=NULL))

graph_online <- ggplot(data=online, aes(x=yyyymm, y=altas_online, group=tipo_cliente, colour=tipo_cliente)) + geom_line() + geom_point() + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de altas") + ggtitle("Altas de clientes online") + scale_y_continuous(breaks=seq(0,1000,100)) + theme(legend.title=element_blank())

graph_online

```


Según estos datos, el número de altas online en el año 2014 es **`r qhive("SELECT SUM(n_altas_online_identificados) FROM da_martalamela.clientes_online WHERE CAST(cod_anno_ej AS INT) = 14")`**. Los datos son similares a los que se obtuvieron con el estudio de altas de clientes que podemos ver en *Digital_On-boarding_vol1.Rmd*, aunque no exactamente iguales. Además, se ve claramente que el dato de altas en los meses de agosto a diciembre de 2014 es incorrecto (¿posible grabación errónea de los datos?) ya que el número de altas en estos meses sumaría **`r qhive("SELECT SUM(n_altas_online_identificados) FROM da_martalamela.clientes_online WHERE CAST(cod_anno_ej AS INT) = 14 AND CAST(cod_mes_ej AS INT) IN (8,9,10,11,12)")`**.

**Idea**: Podríamos intentar calcular la tasa de altas de clientes identificados vs total para los meses anteriores y realizar una aproximación del número de altas en esos meses donde el dato parece incorrecto.

Usando los datos que se muestran en el estudio de altas de clientes *Digital_On-boarding_vol1.Rmd*, tenemos que el número de altas online mensualmente es:

```{r cache=TRUE, echo=FALSE}

altas_online <- qhive("select
year(fecha_sol) as year_fecha_sol,
month(fecha_sol) as month_fecha_sol,
count(distinct cod_persona) as count_distinct_cod_persona
from da_martalamela.altas_online_2014
group by year(fecha_sol), month(fecha_sol)
order by year_fecha_sol, month_fecha_sol")
altas_online$yyyymm <- paste0(altas_online$year_fecha_sol,ifelse(altas_online$month_fecha_sol>=10,altas_online$month_fecha_sol,paste0("0",altas_online$month_fecha_sol)))

graph_altas <- ggplot(data=altas_online, aes(x=yyyymm, y=count_distinct_cod_persona, ymax = max(count_distinct_cod_persona))) + geom_line(aes(group=1), colour="#9933FF") + geom_point(colour="#9933FF") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de altas") + ggtitle("Altas online Digital_On-boarding_vol1") + theme(legend.title=element_blank())

graph_altas

```


**ALTA ONLINE: Estudio de las cookies**

Veámos cómo se desarrolla el proceso de alta vía web a través de las cookies que se generan al comenzar el proceso (al pinchar en "Hazte cliente" en la web bbva.es).
Para ello en primer lugar generamos el número de cookies distintas que han pasado por el paso 0 del proceso de alta online, considerando como paso 0 aquel donde la variable pages toma el valor _particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales_:

```{r cache=TRUE, echo=FALSE}

#do.impala("invalidate metadata omniture.omniture_bbvamice_altas")

do.hive("create table IF NOT EXISTS da_martalamela.num_cookies_paso0_datos_personales as
select partition_id,
count(distinct cod_visitor_id) as num_cookies_paso0
from omniture.omniture_bbvamice_altas
where des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%'
group by partition_id
order by partition_id")

num_cookies_paso0_datos_personales <- qhive("select * from da_martalamela.num_cookies_paso0_datos_personales")
  
graph_paso0_distinct <- ggplot(data=num_cookies_paso0_datos_personales, aes(x=partition_id, y=num_cookies_paso0)) + geom_line(aes(group=1), colour="#66CC99") + geom_point(colour="#66CC99") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de cookies distintas") + ggtitle("Cookies paso 0: datos personales") + scale_y_continuous(breaks=seq(0,15000,1000)) + theme(legend.title=element_blank())

graph_paso0_distinct

```

Comprobamos que ese pico en las cookies de febrero no se deba a un problema con la variable que guarda la cookie, si no que hay una subida general del número de visitas al paso 0 del proceso de altas:

```{r cache=TRUE, echo=FALSE}

do.hive("create table IF NOT EXISTS da_martalamela.total_visitas_paso0_datos_personales as
select partition_id,
count(cod_visitor_id) as num_visitas_paso0
from omniture.omniture_bbvamice_altas
where des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%'
group by partition_id
order by partition_id")

total_visitas_paso0_datos_personales <- qhive("select * from da_martalamela.total_visitas_paso0_datos_personales")

graph_paso0 <- ggplot(data=total_visitas_paso0_datos_personales, aes(x=partition_id, y=num_visitas_paso0)) + geom_line(aes(group=1), colour="#FF9999") + geom_point(colour="#FF9999") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de visitas") + ggtitle("Visitas totales paso 0: datos personales") + scale_y_continuous(breaks=seq(0,25000,1000)) + theme(legend.title=element_blank())

graph_paso0

```

Efectivamente sigue viéndose ese pico en el número de visitas totales al paso 0 del proceso de altas online. Comprobamos si también aumenta el tráfico general de la web en ese mes, o si sigue estable.

```{r cache=TRUE, echo=FALSE}

do.hive("create table IF NOT EXISTS da_martalamela.total_trafico_web as
select partition_id,
count(distinct cod_visitor_id) as num_visitas_distinct,
count(cod_visitor_id) as num_visitas_general
from omniture.omniture_bbvamice_altas
group by partition_id
order by partition_id")

total_trafico_web <- qhive("select * from da_martalamela.total_trafico_web")

#web <- data.frame(partition_id=total_trafico_web$partition_id,
#                trafico_web=c(total_trafico_web$num_visitas_general,total_trafico_web$num_visitas_distinct),
#                tipo_count=c(rep("General",length(total_trafico_web$partition_id)),rep("Cookies distintas",length(total_trafico_web$partition_id###))))

#graph_web <- ggplot(data=web, aes(x=partition_id, y=trafico_web, group=tipo_count, colour=tipo_count)) + geom_line() + geom_point() + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de visitas a la web") + ggtitle("Total tráfico web bbva.es") + theme(legend.title=element_blank())

graph_web_total <- ggplot(data=total_trafico_web, aes(x=partition_id, y=num_visitas_general)) + geom_line(aes(group=1), colour="#FF9999") + geom_point(colour="#FF9999") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de visitas") + ggtitle("Total tráfico web bbva.es") + theme(legend.title=element_blank())

graph_web_distinct <- ggplot(data=total_trafico_web, aes(x=partition_id, y=num_visitas_distinct)) + geom_line(aes(group=1), colour="#66CC99") + geom_point(colour="#66CC99") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de visitas") + ggtitle("Cookies distintas tráfico web bbva.es") + theme(legend.title=element_blank())

graph_web_total

graph_web_distinct

```

En este caso vemos que el tráfico web es estable para el mes de febrero.
**PREGUNTA**: ¿Se debe el pico del mes de febrero en el tráfico del proceso de altas a un aumento puntual? ¿Se ha realizado alguna campaña?

Realizamos el estudio de la variable last_touch_channel por si el incremento de visitas al paso 0 de la web se ha realizado desde algún canal en concreto, para ver una posible campaña.

```{r cache=TRUE, echo=FALSE, fig.width=10, fig.height=7}

do.hive("create table IF NOT EXISTS da_martalamela.last_touch_channel as
select partition_id, des_last_touch_channel,
count(cod_visitor_id) as num_visitas_paso0,
count(distinct cod_visitor_id) as num_cookies_paso0
from omniture.omniture_bbvamice_altas
where des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%'
group by partition_id,des_last_touch_channel
order by partition_id,des_last_touch_channel")

last_touch_channel <- qhive("select * from da_martalamela.last_touch_channel")

#graph_last_touch_channel <- ggplot(data=last_touch_channel, aes(x=partition_id, y=num_visitas_paso0, fill=des_last_touch_channel)) + geom_bar(stat="identity", position=position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de visitas") + ggtitle("Distribución de visitas al paso 0 x last_touch_channel") + guides(fill=guide_legend(title=NULL))

library(plyr)

# Get the levels for type in the required order
last_touch_channel$des_last_touch_channel = factor(last_touch_channel$des_last_touch_channel)
last_touch_channel = arrange(last_touch_channel, partition_id, des_last_touch_channel)

# Calculate the percentages
last_touch_channel = ddply(last_touch_channel, .(partition_id), transform, percent_visitas = num_visitas_paso0/sum(num_visitas_paso0) * 100)
last_touch_channel = ddply(last_touch_channel, .(partition_id), transform, percent_coookies = num_cookies_paso0/sum(num_cookies_paso0) * 100)

last_touch_channel$label_percent_visitas = paste0(sprintf("%.0f", last_touch_channel$percent_visitas), "%")
last_touch_channel$label_percent_coookies = paste0(sprintf("%.0f", last_touch_channel$percent_coookies), "%")

# Plot
graph_last_touch_channel <- ggplot(last_touch_channel, aes(x = factor(partition_id), y = percent_visitas, fill = des_last_touch_channel, label = label_percent_visitas, ymax = max(percent_visitas))) + geom_bar(stat = "identity", width = .7) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("%") + scale_y_continuous(breaks=seq(0,100,10)) + ggtitle("Distribución de visitas paso 0 x last_touch_channel")  + guides(fill=guide_legend(title=NULL)) + geom_text(aes(y = percent_visitas, label = label_percent_visitas), position = "stack", size = 3.5) 

graph_cookies_last_touch_channel <- ggplot(last_touch_channel, aes(x = factor(partition_id), y = percent_coookies, fill = des_last_touch_channel, label = label_percent_coookies, ymax = max(percent_coookies))) + geom_bar(stat = "identity", width = .7) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("%") + scale_y_continuous(breaks=seq(0,100,10)) + ggtitle("Distribución de cookies distintas paso 0 x last_touch_channel")  + guides(fill=guide_legend(title=NULL)) + geom_text(aes(y = percent_coookies, label = label_percent_visitas), position = "stack", size = 3.5) 


graph_last_touch_channel

graph_cookies_last_touch_channel
#multiplot(graph_last_touch_channel, graph_cookies_last_touch_channel, cols=2)

```

Vemos que la distribución en el mes de febrero (tanto de las visitas como de las cookies distinas) es muy similar a las distribuciones de meses anteriores, por lo que no parece que haya un cambio comportamental claro en las visitas al paso 0 de la web.

Nos planteamos si ha habido un cambio en la estructura del proceso de alta en la web, donde el actual paso 0 del alta (aquel donde la variable pages toma el valor _particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales_) en realidad no fuera el paso 0 en meses anteriores a febrero de 2015.

Estudiamos la distribución de los valores que toma la variable pages siempre que incluya la expresión regular _'%particulares:alta clientes:%'_. Para ello comenzamos viendo qué valores tomó esta variable en febrero de 2014 y lo comparamos con los valores que ha tomado en febrero de 2015 (Top 10 casos):

```{r cache=TRUE, echo=FALSE, fig.width=10, fig.height=7}

do.hive("create table IF NOT EXISTS da_martalamela.pages_feb14_vs_feb15 as
select partition_id, des_pages, count(*) as num_casos
from omniture.omniture_bbvamice_altas
where des_pages like '%particulares:alta clientes:%'
and (cast(partition_id as int) = 20140228 or cast(partition_id as int) = 20150228)
group by partition_id, des_pages")

pages_feb14_vs_feb15 <- qhive("select * from da_martalamela.pages_feb14_vs_feb15")

pages_feb14_vs_feb15$partition_id = factor(pages_feb14_vs_feb15$partition_id)
pages_feb14_vs_feb15 = ddply(pages_feb14_vs_feb15, .(partition_id), transform, percent_casos = num_casos/sum(num_casos) * 100)
pages_feb14_vs_feb15$label_percent_casos = paste0(sprintf("%.0f", pages_feb14_vs_feb15$percent_casos), "%")

pages_feb14_vs_feb15 = arrange(pages_feb14_vs_feb15, partition_id, num_casos, decreasing=TRUE)
pages_feb14 <- pages_feb14_vs_feb15[pages_feb14_vs_feb15$partition_id==20140228,]
pages_feb15 <- pages_feb14_vs_feb15[pages_feb14_vs_feb15$partition_id==20150228,]

graph_pages_feb14 <- ggplot(data=pages_feb14[1:10,], aes(x=partition_id, y=percent_casos, fill=des_pages, ymax = max(percent_casos))) + geom_bar(stat="identity", position = position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10), axis.title.y = element_blank()) + scale_y_continuous(breaks=seq(0,100,5)) + ggtitle("Distribución variable pages febrero 2014") + guides(fill=guide_legend(title=NULL)) + coord_flip() + theme(legend.text = element_text(size = 9))

graph_pages_feb15 <- ggplot(data=pages_feb15[1:10,], aes(x=partition_id, y=percent_casos, fill=des_pages, ymax = max(percent_casos))) + geom_bar(stat="identity", position = position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10), axis.title.y = element_blank()) + scale_y_continuous(breaks=seq(0,100,5)) + ggtitle("Distribución variable pages febrero 2015") + guides(fill=guide_legend(title=NULL)) + coord_flip() + theme(legend.text = element_text(size = 9)) + scale_fill_brewer(palette="Spectral")

graph_pages_feb14

graph_pages_feb15

```

Si comparamos los valores de la variable pages que supongan más de un 10% de los casos en alguno de estos dos meses tenemos lo siguiente:

```{r cache=TRUE, echo=FALSE, fig.width=10, fig.height=7}

rel_feb14 <- pages_feb14_vs_feb15$des_pages[(pages_feb14_vs_feb15$percent_casos>10)&(pages_feb14_vs_feb15$partition_id==20140228)]
rel_feb15 <- pages_feb14_vs_feb15$des_pages[(pages_feb14_vs_feb15$percent_casos>10)&(pages_feb14_vs_feb15$partition_id==20150228)]
relevant_pages <- pages_feb14_vs_feb15[pages_feb14_vs_feb15$des_pages%in%c(rel_feb14,rel_feb15),]
relevant_pages = arrange(relevant_pages, partition_id, des_pages)

graph_pages_relevant <- ggplot(relevant_pages, aes(x = factor(partition_id), y = percent_casos, fill = des_pages, label = label_percent_casos, ymax = max(percent_casos))) + geom_bar(stat = "identity", width = .7) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("%") + scale_y_continuous(breaks=seq(0,100,10)) + ggtitle("Distribución de la variable pages: casos relevantes")  + guides(fill=guide_legend(title=NULL)) + geom_text(aes(y = percent_casos, label = label_percent_casos), position = "stack", size = 3.5) + theme(legend.text = element_text(size = 8))

graph_pages_relevant
```

Por tanto, parece que el paso 0 del proceso de alta antes del mes de febrero de 2015 era _particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie_ en lugar del que estábamos considerando.

Además, realizando un estudio de algunos casos de clientes concretos que se dieron de alta vía web en diversos meses de 2014 vemos que su flujo de navegación en el proceso de alta sigue los siguientes pasos:

* particulares:alta clientes:acceso
* particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie
* general:altanif
* https://www.bbva.es/BBVANet/public#public/altaclientesnif
* particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales

Lo podemos ver por ejemplo con:
```{r eval=FALSE, echo=TRUE, cache=TRUE}
ejemplo_1 <- qhive("select * from omniture.omniture_bbvamice_altas where cod_visitor_id='3038143175309473909_6917535637595783421'")
ejemplo_2 <- qhive("select * from omniture.omniture_bbvamice_altas where cod_visitor_id='3789059567402647528_292812151808439210'")
ejemplo_3 <- qhive("select * from omniture.omniture_bbvamice_altas where cod_visitor_id='3037212247588934527_4611687152298773015'")
ejemplo_4 <- qhive("select * from omniture.omniture_bbvamice_altas where cod_visitor_id='3030644609085685441_6917530144332581948'")
```

Si hacemos el conteo de cookies distintas que han comenzado el proceso de alta online en el paso _particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie_ (hasta enero de 2015) o _particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales_ (a partir de febrero de 2015) obtenemos la siguiente distribución:

```{r cache=TRUE, echo=FALSE}

do.hive("create table IF NOT EXISTS da_martalamela.num_cookies_paso0_definitivo as
select partition_id,
count(distinct cod_visitor_id) as num_cookies_paso0
from omniture.omniture_bbvamice_altas
where (des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%' and cast(partition_id as int) >= 20150228)
or (des_pages like'%particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie%' and cast(partition_id as int) < 20150228)
group by partition_id
order by partition_id")

num_cookies_paso0_definitivo <- qhive("select * from da_martalamela.num_cookies_paso0_definitivo")

graph_paso0_distinct_def <- ggplot(data=num_cookies_paso0_definitivo, aes(x=partition_id, y=num_cookies_paso0)) + geom_line(aes(group=1), colour="#66CC99") + geom_point(colour="#66CC99") + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de cookies distintas") + ggtitle("Cookies paso 0 modificación") + scale_y_continuous(breaks=seq(0,15000,1000)) + theme(legend.title=element_blank())

graph_paso0_distinct_def

```

El número de pasos del proceso de alta es considerablemente alto, como podemos ver con el siguiente conteo:
```{r eval=TRUE, echo=FALSE, cache=TRUE}
qhive("select des_pages, count(*)
from omniture.omniture_bbvamice_altas
where des_pages like '%particulares:alta clientes:%'
group by des_pages
order by des_pages")
```

Construimos la siguiente segmentación para los pasos principales del proceso de alta online:

+ Paso 0: cuando la variable _pages_ toma el valor *particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales* (a partir de febrero de 2015) o toma el valor *particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie* (hasta enero de 2015)
+ Paso 1: cuando la variable _pages_ contiene la expresión regular *particulares:alta clientes:[...]:paso 0* o *particulares:alta clientes:[...]:paso 1*
+ Paso 2: cuando la variable _pages_ contiene la expresión regular *particulares:alta clientes:[...]:paso 2*
+ Paso 3: cuando la variable _pages_ contiene la expresión regular *particulares:alta clientes:[...]:paso 3*

El resto de pasos del proceso de alta son variables y ocurren con mucha menos frecuencia.

Veámos su distribución en los últimos meses, deberíamos comprobar cómo los potenciales clientes van abandonando el proceso de alta a medida que éste avanza (**¡REVISAR!**):


```{r cache=TRUE, echo=FALSE, fig.width=7, fig.height=7}
do.hive("create table IF NOT EXISTS da_martalamela.segmentacion_proceso_alta as 
select partition_id,
x.pasoprocesoalta,
count(distinct x.cod_visitor_id) as count_cookies_dist
from
(
select A.*,
case
when (des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%'
and cast(partition_id as int) >= 20150228) or (des_pages like'%particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie%' and cast(partition_id as int) < 20150228) then 'paso_0'
when des_pages like '%particulares:alta clientes:%' and (des_pages like '%paso 0 %' or des_pages like '%paso 1 %') then 'paso_1'
when des_pages like '%particulares:alta clientes:%' and des_pages like '%paso 2 %' then 'paso_2'
when des_pages like '%particulares:alta clientes:%' and des_pages like '%paso 3 %' then 'paso_3'
else ' '
end as pasoprocesoalta
from omniture.omniture_bbvamice_altas A
where des_pages like '%particulares:alta clientes:%'
) x
where x.pasoprocesoalta like '%paso%'
group by partition_id, x.pasoprocesoalta
order by partition_id, x.pasoprocesoalta")

segmentacion_proceso_alta <- qhive("select * from da_martalamela.segmentacion_proceso_alta")

graph_segmentacion_proceso_alta <- ggplot(data=segmentacion_proceso_alta, aes(x=partition_id, y=count_cookies_dist, fill=pasoprocesoalta, ymax = max(count_cookies_dist))) + geom_bar(stat="identity", position=position_dodge(), width=0.9) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Número de cookies distintas") + ggtitle("Distribución cookies x paso proceso alta") + guides(fill=guide_legend(title=NULL))

graph_segmentacion_proceso_alta

```


Hemos observado además que en Omniture existe la variable _evar21altaspasodelprocesoevar21_. Extraemos esa variable para los meses de enero y febrero de 2015 y nos preguntamos lo siguiente: ¿Aporta esta variable información nueva sobre el proceso de alta, o realiza algún tipo de segmentación sobre los diferentes pasos? Si realizamos la siguiente consulta:

```{r eval=FALSE, echo=TRUE, cache=TRUE}
qhive("select distinct pages,evar21altaspasodelprocesoevar21, count(*)
from da_martalamela.altas_paso0_1t_evar21_2015
where pages like '%particulares:alta clientes:%'
group by pages, evar21altaspasodelprocesoevar21
order by pages
LIMIT 25")
```

Se comprueba que toma el mismo valor que la variable _pages_ para los casos de altas, con lo cual la información que aporta es redundante y poco aprovechable para nuestra segmentación.


----
**ALTAS ROPO: Estudio de las altas en oficina que pueden considerarse ROPO**

Extraemos los códigos de persona de los clientes dados de alta en **oficina** en el periodo oct14-dic14 y buscamos hasta 3 meses después si se han conectado a la web de bbva.es para guardar las **cookies asociadas a esos códigos de persona** (histórico disponible actualmente hasta febrero de 2015).

Tenemos **`r qhive("select count(distinct cod_pers_trs) from da_pro.transacciones_por_canal where cast(cod_serv_dv as int)=1 and cast(cod_deve_trn as int)=758 and fec_soli_trn between '2014-10-01' and '2014-12-31' and cod_pers_trs not like '@%' and cast(partition_id as int) > 20140930 and cast(partition_id as int) < 20150131")`** altas en oficina de clientes identificados (*cod_pers_trs* informado) en el periodo oct14-dic14. Comprobamos si se han conectado a su cuenta en la web bbva.es y les asociamos sus cookies:


```{r eval=TRUE, echo=TRUE, cache=TRUE}

do.hive("create table IF NOT EXISTS da_martalamela.merge_cod_pers as
select A.cod_pers_trs,
A.fec_soli_trn,
B.cod_visitor_id
from
(
 select
 cod_visitor_id,
 cod_persona
 from omniture.omniture_bbvamice_altas
 where cod_persona not like '@%'
 and cast(partition_id as int) > 20140930
) B
left join
(
 select
 cod_pers_trs,
 max(fec_soli_trn) as fec_soli_trn
 from da_pro.transacciones_por_canal
 where cast(cod_serv_dv as int)=1
 and cast(cod_deve_trn as int)=758
 and fec_soli_trn between '2014-10-01' and '2014-12-31'
 and cod_pers_trs not like '@%'
 and cast(partition_id as int) > 20140930
 and cast(partition_id as int) < 20150131
 group by cod_pers_trs
 order by fec_soli_trn
) A
on cast(A.cod_pers_trs as int)=cast(B.cod_persona as int)
where A.cod_pers_trs is not null
group by A.cod_pers_trs, A.fec_soli_trn, B.cod_visitor_id
order by A.fec_soli_trn, A.cod_pers_trs")

merge_cod_pers <- qhive("select * from da_martalamela.merge_cod_pers")

head(merge_cod_pers)

```

Tenemos **`r qhive("select count(distinct cod_pers_trs) from da_martalamela.merge_cod_pers")`** altas en oficina de clientes identificados (*cod_pers_trs* informado) en el periodo oct14-dic14, y les conseguimos asociar **`r qhive("select count(distinct cod_visitor_id) from da_martalamela.merge_cod_pers")`** cookies distintas a las que se han conectado después de su alta.

Comprobamos si entraron al proceso de alta online de la web bbva.es antes de su alta en oficina, utilizando para ello las cookies asociadas que hemos obtenido:

```{r eval=TRUE, echo=TRUE, cache=TRUE}

do.hive("create table IF NOT EXISTS da_martalamela.merge_visitor_id as
select A.cod_visitor_id,
A.cod_persona,
A.str_date,
B.cod_pers_trs,
B.fec_soli_trn
from
(
  select
  cod_visitor_id,
  cod_persona,
  str_date
  from omniture.omniture_bbvamice_altas
  where (des_pages like '%particulares:alta clientes:no es cliente:paso 0 alta clientes contratacion-datos personales%' and cast(partition_id as int) >= 20150228) or (des_pages like'%particulares:alta clientes:es cliente:paso 1 darse de alta-alta en bbva.es con dnie%' and cast(partition_id as int) < 20150228)
) A
left join da_martalamela.merge_cod_pers B
on A.cod_visitor_id=B.cod_visitor_id
where B.cod_pers_trs is not null")

merge_visitor_id <- qhive("select * from da_martalamela.merge_visitor_id")

head(merge_visitor_id)

# Cambiamos el formato de la fecha y definimos la condición de ser ROPO:
# la fecha de consulta del proceso de alta online debe ser anterior estrictamente a la fecha de alta en oficina
merge_visitor_id$str_date_tr <- as.Date(merge_visitor_id$str_date, "%B %e %Y")
merge_visitor_id$ropo <- ifelse(merge_visitor_id$str_date_tr<merge_visitor_id$fec_soli_trn,1,0)


```

Tenemos **`r length(unique(merge_visitor_id$cod_pers_trs[merge_visitor_id$ropo==1]))`** personas informadas y **`r length(unique(merge_visitor_id$cod_visitor_id[merge_visitor_id$ropo==1]))`** cookies distintas asociadas a las que se conectaron al proceso de alta online **antes de su proceso de alta en oficina**.

Construimos una tabla donde identificamos a los diferentes clientes de OFICINA/ROPO, con su código de persona asociado:

```{r eval=TRUE, echo=TRUE, cache=TRUE}

do.hive("create table IF NOT EXISTS da_martalamela.listado_clientes_oficina as
select cod_pers_trs,
fec_soli_trn,
cod_anno_ej,
cod_mes_ej
from da_pro.transacciones_por_canal
where cast(cod_serv_dv as int)=1
and cast(cod_deve_trn as int)=758
and cast(partition_id as int) > 20131231")
listado_clientes_oficina <- qhive("select * from da_martalamela.listado_clientes_oficina")

do.hive("create table IF NOT EXISTS da_martalamela.listado_clientes_online as
select cod_pers_trs,
fec_soli_trn,
cod_anno_ej,
cod_mes_ej
from da_pro.transacciones_por_canal
where cod_trnfims='KGCRTQ41'
and cast(cod_retortr as int)=0
and cast(partition_id as int) > 20131231")
listado_clientes_online <- qhive("select * from da_martalamela.listado_clientes_online")

merge_visitor_id <- qhive("select * from da_martalamela.merge_visitor_id")
merge_visitor_id$str_date_tr <- as.Date(merge_visitor_id$str_date, "%B %e %Y")
merge_visitor_id$ropo <- ifelse(merge_visitor_id$str_date_tr<merge_visitor_id$fec_soli_trn,1,0)

merge_visitor_id_cod_pers_trs <- data.frame(cod_pers_trs=unique(merge_visitor_id$cod_pers_trs[!is.na(merge_visitor_id$cod_pers_trs)&merge_visitor_id$ropo==1]), TIPO="ROPO")

merge_ropo <- merge(data.frame(cod_pers_trs=unique(listado_clientes_oficina$cod_pers_trs[!is.na(listado_clientes_oficina$cod_pers_trs)&listado_clientes_oficina$cod_anno_ej=="14"&listado_clientes_oficina$cod_mes_ej%in%c("10","11","12")]), TIPO="OFICINA"),
                    merge_visitor_id_cod_pers_trs,
                    by="cod_pers_trs",all.x=TRUE)
merge_ropo$TIPO <- ifelse(!is.na(merge_ropo$TIPO.y),"ROPO","OFICINA")

write.hive(merge_ropo[,c("cod_pers_trs","TIPO")], "da_martalamela.listado_clientes_ropo", drop.table = TRUE)

```

Tenemos **`r qhive("select count(*) from da_martalamela.listado_clientes_ropo where tipo='ROPO'")`** clientes ROPO en el periodo octubre14 - diciembre14, y **`r qhive("select count(*) from da_martalamela.listado_clientes_ropo where tipo='OFICINA'")`** clientes catalogados estrictamente como OFICINA. Esto es 1225/(1225+136829)x100 aproximadamente un **1% de los clientes que se dan de alta por oficina podrían considerarse como altas ROPO-ONLINE**.

**¡OJO!** Cálculo aproximado de las altas ONLINE:
Tenemos 555+822+751=**2128** clientes sin identificar que se han catalogado como alta online en el periodo octubre14-diciembre14. La proporción de los 6 meses anteriores de clientes identificados frente a los no identificado es al menos del 80%, y su media es del **85%**. Suponemos por tanto **1800** altas de clientes online en esos 3 meses.
El multiplicador ROPO (1225 ROPO frente a 1800 ONLINE) sería por tanto de 1.5: **por cada 1.5 altas ONLINE habría +1 alta ROPO atribuible a ONLINE**.

Usando los datos que tenemos en el estudio de altas de clientes *Digital_On-boarding_vol1.Rmd*, tenemos **`r qhive("select count(*) from da_martalamela.altas_online_2014 where fecha_sol between '2014-10-01' and '2014-12-31'")`** altas online en el periodo octubre14-diciembre14. El multiplicador ROPO (1225 ROPO frente a 519 ONLINE) sería por tanto de 0.5: **por cada 0.5 altas ONLINE habría +1 alta ROPO atribuible a ONLINE**. El factor ROPO valdría 1225/519 = **2.34**.


Veámos cuál es la **rentabilidad** de los clientes ROPO vs OFICINA (a fin de cierre de mes de febrero de 2015 y su rentabilidad media en el 4ª trimestre de 2014):

```{r eval=TRUE, echo=TRUE, cache=TRUE}

do.hive("create table IF NOT EXISTS da_martalamela.rentabilidad_clientes_ropo_201502 as
select b.cod_pers_trs as cod_pers_trs,
b.tipo as tipo,
a.rentabilidad_imp_rca as rentabilidad_imp_rca
from da_martalamela.listado_clientes_ropo b
left join
(
 select
 cod_persctpn,
 sum(imp_rca) as rentabilidad_imp_rca
 from da_pro.rentabilidad_clientes
 where cast(partition_id as int) = 20150228
 group by cod_persctpn
) a
on cast(a.cod_persctpn as int)=cast(b.cod_pers_trs as int)")
rentabilidad_clientes_ropo_201502 <- qhive("select * from da_martalamela.rentabilidad_clientes_ropo_201502")

rentabilidad_clientes_ropo_201502_acum <- data.frame(tipo=c("OFICINA","ROPO"),
           rentabilidad_imp_rca=c(sum(rentabilidad_clientes_ropo_201502$rentabilidad_imp_rca[rentabilidad_clientes_ropo_201502$tipo=="OFICINA"&!is.na(rentabilidad_clientes_ropo_201502$rentabilidad_imp_rca)]),
                                  sum(rentabilidad_clientes_ropo_201502$rentabilidad_imp_rca[rentabilidad_clientes_ropo_201502$tipo=="ROPO"&!is.na(rentabilidad_clientes_ropo_201502$rentabilidad_imp_rca)])))

graph_rentabilidad_clientes_ropo_201502 <- ggplot(rentabilidad_clientes_ropo_201502_acum, aes(x = factor(tipo), y = rentabilidad_imp_rca, fill = tipo, label=rentabilidad_imp_rca, ymax = max(rentabilidad_imp_rca))) + geom_bar(stat = "identity", width = .7) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Rentabilidad (€)") + ggtitle("Rentabilidad (en €) de clientes OFICINA/ROPO febrero15")  + theme(legend.position="none") + geom_text(aes(y = rentabilidad_imp_rca), position = "stack", size = 3.5)

graph_rentabilidad_clientes_ropo_201502

```

```{r eval=TRUE, echo=TRUE, cache=TRUE}

do.hive("create table IF NOT EXISTS da_martalamela.rentabilidad_clientes_ropo_4T2014 as
select b.cod_pers_trs as cod_pers_trs,
b.tipo as tipo,
avg(a.rentabilidad_imp_rca) as rentabilidad_imp_rca
from da_martalamela.listado_clientes_ropo b
left join
(
 select
 cod_persctpn,
 partition_id,
 sum(imp_rca) as rentabilidad_imp_rca
 from da_pro.rentabilidad_clientes
 where cast(partition_id as int) in (20141031,20141130,20141231)
 group by cod_persctpn,partition_id
) a
on cast(a.cod_persctpn as int)=cast(b.cod_pers_trs as int)
group by b.cod_pers_trs,b.tipo
order by cod_pers_trs")
rentabilidad_clientes_ropo_4T2014 <- qhive("select * from da_martalamela.rentabilidad_clientes_ropo_4T2014")

rentabilidad_clientes_ropo_4T2014_acum <- data.frame(tipo=c("OFICINA","ROPO"),
           rentabilidad_imp_rca=c(sum(rentabilidad_clientes_ropo_4T2014$rentabilidad_imp_rca[rentabilidad_clientes_ropo_4T2014$tipo=="OFICINA"&!is.na(rentabilidad_clientes_ropo_4T2014$rentabilidad_imp_rca)]),
                                  sum(rentabilidad_clientes_ropo_4T2014$rentabilidad_imp_rca[rentabilidad_clientes_ropo_4T2014$tipo=="ROPO"&!is.na(rentabilidad_clientes_ropo_4T2014$rentabilidad_imp_rca)])))

graph_rentabilidad_clientes_ropo_4T2014 <- ggplot(rentabilidad_clientes_ropo_4T2014_acum, aes(x = factor(tipo), y = rentabilidad_imp_rca, fill = tipo, label=rentabilidad_imp_rca, ymax = max(rentabilidad_imp_rca))) + geom_bar(stat = "identity", width = .7) + theme(axis.title.x = element_blank(), axis.text.x  = element_text(angle=90, size=10)) + ylab("Rentabilidad (€)") + ggtitle("Rentabilidad (en €) de clientes OFICINA/ROPO 4T2014")  + theme(legend.position="none") + geom_text(aes(y = rentabilidad_imp_rca), position = "stack", size = 3.5)

graph_rentabilidad_clientes_ropo_4T2014

```

