---
title: "KPI Categorizador Tarjetas"
output: html_document
author: "Susana M."
date: 02/11/2015
---
```{r titlekeys, echo=FALSE}
# This is the first mandatory section.

title <- "[Advisory and Predictive Models]: KPI CategorizadorTarjetas"

# Keywords. Text separated by commas. E.g. keywords <- 'customer health, recibos' 
# Keywords can classify the attribute in categories such as 'valor, vinculación, digitalidad', describe used tables such as 'recibos, 
# transacciones tarjetas, segmento plan uno' or include other relevant info. Search keywords in the portal to find commonly used terms
# and create new keywords only if justified.

keywords  <- 'rms, cifs,categorizador'  
```

``` {r init, echo=FALSE,eval=TRUE}
# This is the second mandatory section.

suppressMessages(library(DBI))  	# This avoids loading messages and warnings showing up
suppressMessages(library(rJava))
suppressMessages(library(ggplot2))
suppressMessages(library(grid))
suppressMessages(library(hexbin))
suppressMessages(library(lattice))
suppressPackageStartupMessages(library('data.table'))
`%ni%` <- Negate(`%in%`)
options(warn=-1, scipen=3, width=450)
source('~/bda_clarity/tools/warehouse_basics.R')
source('~/bda_clarity/tools/methods_connect.R')
```

```{r dependencies, cache=TRUE, echo=FALSE}

mc <- clarity.use_table(DEPENDENCY_OTHER_TABLES,
                                'rms_master.movimientos_tarjetas',
                                select = '*',
                                sqname = 'mc')


cat <- clarity.use_table(DEPENDENCY_OTHER_TABLES,
                                'da_categorizacion.categorizados_mmpp_historico',
                                select = '*',
                                sqname = 'cat')

```

## Context

Actualmente los movimientos de cuentas y tarjetas ya tienen una categoría, pero desde Banca Digital surge la necesidad de actualizar y unificar dichas categorías mediante una única Taxonomía de dos niveles, teniendo en cuenta la naturaleza del movimiento y cuya descripción aporte valor añadido a los clientes del banco. Los movimientos a categorizar proceden de dos fuentes diferentes: RMS (movimientos de cuenta) y MMPP (Medios de Pagos, movimientos de  tarjeta).

Los movimientos procedentes de las fuentes, se categorizan en bloque, utilizando una Taxonomía común y unas reglas de negocio que permiten mejorar la categorización inicial.

Existen dos categorías/subcategorías especiales:

- **0 No categorizable /0 No asociable a gasto o ingreso**. Para una serie de códigos (ramo/talón) que han sido seleccionados por Banca Digital se les ha asignado esta categoría/subcategoría que será tratada de manera especial por las aplicaciones terceras que usen los movimientos categorizados.

- **999 Sin categorizar/999 Sin categorizar**. Esta categoría y subcategoría está asociada al hecho de que no todos los códigos ramo y talón están presente en la taxonomía, pero todos los movimientos deben estar categorizados con algún valor. 


En el caso de tarjetas:

- Si el ramo del movimiento es **‘0','6010', ó ‘'6011'**, entonces se mira el código de transacción del movimiento y si es alguno de los que se encuentran en la siguiente tabla, el movimiento deja de ser ‘Sin categorizar’ y se recategoriza con la información de las columnas id1 (id categoría), id2 (id subcategoría). 

```{r , echo=FALSE,cache=TRUE,}
q <-"select * from da_categorizacion.cod_transaccion";
transacciones <-qhive(q);
knitr::kable(transacciones)
```

- Además, si el código de transacción es **'7','17','27' o '37'** y la descripción de la transacción (campo *des_democu* procedente de MMPP) contiene la palabra *‘TRASP’* entonces el movimiento se recategorizará con *0 No categorizable*. Si el código de transacción es ‘82’ y la descripción de la transacción contiene la palabra *‘COMISION’* se recategoriza como *‘Banco y servicios financieros’ ‘Comisiones, gastos e intereses’*. Si el código de transacción es ‘72’ y la descripción de la transacción contiene la palabra *‘BONIFICACION’*, se recategoriza como *‘Ingresos’, ‘Otros ingresos’*.


## Stats

```{r , echo=FALSE,cache=TRUE,}

q <-"select count(*) from da_categorizacion.categorizados_mmpp_historico where year='2015'";
total_mmpp<-qhive(q);
q <-"SELECT COUNT( * ) AS total, fec_transaccion FROM da_categorizacion.categorizados_mmpp_historico where year='2015' and type='CAT' GROUP BY fec_transaccion";
total_cat <-qhive(q)
total_cat$fec_transaccion<-as.Date(total_cat$fec_transaccion,"%m-%d-%y")
sum_cat<-sum(total_cat$total)


# No categorizados
q <-"SELECT COUNT( * ) AS total, fec_transaccion FROM da_categorizacion.categorizados_mmpp_historico where year='2015' and type='NOCAT' GROUP BY fec_transaccion";
total_nocat <-qhive(q)
total_nocat$fec_transaccion<-as.Date(total_nocat$fec_transaccion,"%m-%d-%y")
sum_nocat<-sum(total_nocat$total)

p_cat<-round((as.integer(sum_cat )*100/(sum_cat+sum_nocat)),digits=2)
p_nocat<-round((as.integer(sum_nocat )*100/(sum_cat+sum_nocat)),digits=2)
             
table_mmpp<- merge(total_cat,total_nocat,by='fec_transaccion')
colnames(table_mmpp)[2] <- 'cat'
colnames(table_mmpp)[3] <- 'nocat'

q <-"SELECT COUNT( * ) AS total, fec_transaccion FROM da_categorizacion.categorizados_mmpp_historico where year='2015' and type='CAT' and type_cat='A' GROUP BY fec_transaccion";
total_cat_A <-qhive(q)
sum_recat<-sum(total_cat_A$total)
p_recat<-round((as.integer(sum_recat )*100/(sum_cat+sum_nocat)),digits=2)
q <-"SELECT COUNT( * ) AS total, fec_transaccion FROM da_categorizacion.categorizados_mmpp_historico where year='2015' and type='CAT' and type_cat='N' GROUP BY fec_transaccion";
total_cat_N <-qhive(q)
table_mmpp_cat<- merge(total_cat_A,total_cat_N,by="fec_transaccion")
colnames(table_mmpp_cat)[2] <- "recat"
colnames(table_mmpp_cat)[3] <- "cat"

```

Total:

- Movimientos categorizados en 2015: `r p_cat`%, `r p_recat`% recategorizados

- Movimientos no categorizados en 2015: `r p_nocat`%

``` {r echo=FALSE, fig.width=8, fig.height=5, cache=TRUE}
library(plyr)
#total_trans <-  rbind(recat_sum,genericos)
#ce <- ddply(total_trans, "fec_movimien", transform, percent_num_transfer = total / sum(total) * 100)
#ce <- ce[order(-ce$percent_num_transfer),]
#ce <- ddply(ce, "fec_movimien", transform, label_y = cumsum(percent_num_transfer))

#ggplot(ce, aes(x=fec_movimien, y=percent_num_transfer, fill=subcategory)) + geom_bar(width= 0.6, stat="identity") +
#ggtitle("Transferencia realizda vs. Recategorizados") + geom_text(aes(y = label_y, label = round(percent_num_transfer,digits=1)), vjust=1.5, size=3, colour="white" );


```



## Listado no categorizados

```{r , echo=FALSE,cache=TRUE,}
today<-format(Sys.time(), ' %Y%m')
q <-paste("select cod_Ramo as cod, des_Ramo as descrip, sum(total) as stotal from da_categorizacion.estadisticas_no_categorizados_mmpp_historico where raw_timestamp >",today, "group by cod_Ramo, des_ramo order by stotal DESC")
listado_no_cat <-qhive(q)
listado_no_cat[is.na(listado_no_cat)] <- 'NULL'
listado_no_cat
```









